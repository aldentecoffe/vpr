# Лабораторная работа #8 - Шифрование LUKS

## Материалы
- [Lab-8 - Шифрование LUKS.pdf](https://github.com/xarll/vpr/blob/main/items/os1/lab8/Lab-8%20-%20%D0%A8%D0%B8%D1%84%D1%80%D0%BE%D0%B2%D0%B0%D0%BD%D0%B8%D0%B5%20LUKS.pdf)

## Задания для самостоятельной работы
...

## Работа

Перед началом выполнения лабораторной работы необходимо настроить ВМ.

Выбираем машину с которой будем работать, заходим в пункт настройки.

![1](https://user-images.githubusercontent.com/100228870/237048953-f2166cd4-0bee-41c9-b57a-7ca781d2d521.jpg)

Переходим в раздел **Носители**. Нажимаем ЛКМ на **Контроллер: SATA** и выбираем второй пунт **Добавить жесткий диск**

![2](https://user-images.githubusercontent.com/100228870/237049492-1675b3da-65c1-4a36-b9c6-db6564111ed7.jpg)

Создаём новый виртуальный жёсткий диск нажатием кнопки **Создать**.

![3](https://user-images.githubusercontent.com/100228870/237050293-3b8303dc-4dc2-4409-844f-6619458420b5.jpg)

Находим в списке ниже наш новый хард, нажимаем на него ЛКМ и подверждаем выбор

![4](https://user-images.githubusercontent.com/100228870/237051940-8f185145-cdff-47a9-9d17-889852b46393.jpg)

Теперь на нашей ВМ установлено два виртуальных жестких диска, нажимаем **ОК** (Шифрованием второго харда мы и будем заниматься)

![5](https://user-images.githubusercontent.com/100228870/237052762-92edb7e8-7468-4b73-b388-c953c03c1f99.jpg)

Теперь запускаем ВМ и входим из под су.

Устанавливаем crypsetup и smartmontools, для этого вводим в консоль следующее:
```
apt install smartmontools
```
```
apt-get install cryptsetup
```

Далее вводим в консоль
```
fdisk -l
```

Если указания выше были выполнены корректно мы увидим следующее:

Помимо первого жёсткого диска **/dev/sba**, в выводе консоли будет присутствовать добавленный вручную второй виртуальный хард **/dev/sdb** 

![6](https://user-images.githubusercontent.com/100228870/237054952-239960a2-4948-4c59-85dc-6fcf2f25c60f.jpg)

Чтобы получить более детальную информацию о дисках и разделах можно использовать:
```
lsblk
```
![7](https://user-images.githubusercontent.com/100228870/237056631-8a751b63-3a89-4aad-a64b-903a91e5f39a.jpg)

Теперь необходимо на диске **/dev/sdb** создать зашифрованный раздел.
```
cryptsetup luksFormat /dev/sdb
```
Доказываем консоли серьёзность наших намеренний введя **YES**

Далее нам предложено будет указать **ключ-фразу**, в моём случае это будет слово *key*

Ждём пару секунд, пока ВМ переварит наши действия.

![8](https://user-images.githubusercontent.com/100228870/237059300-520470df-6d10-4150-952f-a21b8e1a6854.jpg)

Далее необходимо открыть LUKS-том
```
cryptsetup luksOpen /dev/sdb encrypted_partition
```
*encrypted_partition* - название раздела (можем ввести любое своё)

Далее у нас запросят ключ-фразу. Вводим её.

![9](https://user-images.githubusercontent.com/100228870/237061513-84c536ae-d6cf-44e4-a177-de1fdebdd43c.jpg)

Если все пункты выше выполнены правильно, то том станет отображаться в **/dev/mapper/encrypted_partition**

Первый способ для проверки:
```
ls /dev/mapper
```
![10](https://github.com/coonsst/vpr/assets/100228870/41769204-c05f-4da2-9d89-b7b3a65c91c6)

Второй способ для проверки:
```
lsblk
```
С помощью утилиты мы можем увидеть следующее:

Виртуальный жёсткий диск **/dev/sdb** имеет зашифрованый том **encrypted_partition** (подтверждением этому служит слово **krypt** в столбце **TYPE**)

![11](https://github.com/coonsst/vpr/assets/100228870/e849a485-542f-4a33-96ad-3cc600911d40)

Теперь необходимо проверить состояние зашифрованного диска, вводим в консоль:
```
cryptsetup status encrypted_partition
```
В выводе мы увидим тип и метку тома:

![12](https://github.com/coonsst/vpr/assets/100228870/4db9b755-812c-4b5f-9d66-9f7b1902f03e)

Теперь у вас есть защищенный паролем шифрованный диск. 

Следующим этапом будет создание файловой системы на этом диске, чтобы операционная система могла использовать ее для хранения файлов.

Сейчас мы должны создать и монтировать файловую систему. Сначала посмотрим на текущее доступное дисковое пространство ВМ.
```
df -h
```

![13](https://github.com/coonsst/vpr/assets/100228870/db954abe-6a6b-4d81-8526-d5fda291ad28)

Сейчас /dev/mapper/encrypted_partition не отображается в этом списке, потому что том еще не доступен для сервера. Чтобы сделать его доступным, необходимо создать и смонтировать файловую систему.


Используем утилиту **mkfs**, для создания файловой системы **ext4** в томе.
```
mkfs.ext4 /dev/mapper/encrypted_partition 
```
![14](https://github.com/coonsst/vpr/assets/100228870/cae3f500-df83-4ce7-b79f-9a8050ba1e6d)

Когда файловая система будет создана, можно её смонтировать, что означает, что она будет доступна для операционной системы нашей ВМ.

*!Правилом хорошего тона является монтирование файловых систем в папки "mnt" и "media". Обычно папку "mnt" используют для монтирования разделов, а папку "media" для монтирования съемных носителей информации!*

Перед монтированием создадим папку **luks_dir** в директории **/mnt/**
```
mkdir /mnt/luks_dir
```
![15](https://github.com/coonsst/vpr/assets/100228870/d0a5d91a-ce53-46d0-bee6-ad0c244833b3)

Создаём точку монтирования, к которой будет прикреплена файловая система. 

Смонтируем файловую систему в новую папку.
```
mount /dev/mapper/encrypted_partition /mnt/luks_dir
```
![16](https://github.com/coonsst/vpr/assets/100228870/cf1b6265-1257-4450-9fbe-a23da7eb0860)

Чтобы убедиться, что все работает, проверим доступное дисковое пространство ВМ:
```
df -h
```
![17](https://github.com/coonsst/vpr/assets/100228870/67b93d29-5678-4d1a-8c59-2eefee239d65)

Теперь в списке появится **/dev/mapper/encrypted_partition**

Это означает, что зашифрованная файловая система подключена и доступна для использования.

Добавим новую ключеву фразу как того требует задание:
```
cryptsetup luksAddKey /dev/sdb
```
Для этого у нас потребуют любую уже существующую ключ-фразу (В своём случае я ввожу *key*)

А после добавляем новую ключ-фразу, пускай это будет *key2*

![18](https://github.com/coonsst/vpr/assets/100228870/3337544d-7988-4c47-a99c-11a9d9bbc042)

Теперь необходимо посмотреть количество используемых ключей для нашего раздела и узнать сколько свободных слотов осталось.

```
cryptsetup luksDump /dev/sdb
```
![19](https://github.com/coonsst/vpr/assets/100228870/fec6b75d-bf57-4fd6-9577-902efcaeeaf9)

Но! Файл очень большой, а нам надо *посмотреть его построчно*. Поэтому в домашней директории создаём файл **l_dump**
```
touch ~/l_dump
```
![20](https://github.com/coonsst/vpr/assets/100228870/49658436-2cdc-4228-a780-953f45b10cca)

Далее записываем список ключей в этот файл.
```
cryptsetup luksDump /dev/sdb >> ~/l_dump
```
И открываем **l_dump** через редактор **nano**
```
nano ~/l_dump
```
В файле мы видим следующее:

Слоты 0 (ключ **key**) и 1 (ключ **key2**) заняты. Соотвественно остальные слоты (2,3,4,5,6,7) свободны.

![21](https://github.com/coonsst/vpr/assets/100228870/0235b5b9-2a35-4a49-98e5-40a3d528e95a)

Теперь необходимо создать ключ-файл.
