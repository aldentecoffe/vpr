# Лабораторная работа #10 - Межсетевой экран (iptables)

## Материалы
- [Lab-10 - Iptables.docx](https://github.com/xarll/vpr/blob/main/items/os1/lab10/Lab-10%20-%20Iptables.docx)

## Работа

###1. Настройка ВМ

Для выполнения работы необходимы:
- Ubuntu Server (https://ubuntu.com/download/desktop)
- Ubuntu Desktop (https://ubuntu.com/download/server)

Для избежания траты времени и повторной установки + настройки **FTP** и **SMB** предлагаю клонировать машины, которые мы использовали для выполнения 9 лабораторной работы.

![1](https://github.com/xarll/vpr/assets/100228870/5c829244-5c26-418b-a1a8-f270d2106de4)

При клонировании, в графе **"Политика MAC адреса"** в выпадающем меню выбираем **"Сгенерировать новые MAC адреса всех сетевых адаптеров"**.

![2](https://github.com/xarll/vpr/assets/100228870/3f5b9e01-994a-47a4-912c-954587e559a9)

Проведём эту процедуру для обоих машин (десктопной и серверной). В результате имеем:

![3](https://github.com/xarll/vpr/assets/100228870/f6733e97-3acb-477a-a7f4-737d0df0cc6d)

Перейдём к настройке сетей в данных машинах и разберём зачем это вообще нужно. 

В данный момент на машинах выбрана сеть NAT, в которой IPa им выдаёт DHCP. Нам же необходимы статические адреса для выставления правил в **iptables**

Поэтому на обоих ВМ необходимо сменить **NAT сеть** на **Внутреннюю сеть**.

Выбираем ВМ --> Настроить --> Сеть --> Тип подключения: Внутренняя сеть

![4](https://github.com/xarll/vpr/assets/100228870/105e16e5-06bf-433a-a31c-e8ec2a3f41e2)

### 2. Адреса ВМ

Для начала установим статические IPa для наших ВМ.

Для серверной ВМ:
```
sudo nano /etc/netplan/*.yaml
```
Меняем следующее:
```
      dhcp4: false
      addresses: [172.16.0.1/16]
    version: 2
```

![8](https://github.com/xarll/vpr/assets/100228870/5508b347-9ca3-42e5-bb88-e956f9b22458)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Далее применяем изменения следующими командами:
```
sudo netplan try
sudo netplan apply
```

Cмотрим IPa серверной ВМ:
```
ip a 
```

![9](https://github.com/xarll/vpr/assets/100228870/8cf8baa8-006b-42b9-b3d9-5cf88398ec25)

Для десктопной ВМ:

Включаем ВМ и выбираем окно **Show Applications**

![4](https://github.com/xarll/vpr/assets/100228870/3319a1b9-da84-4ea5-b2e1-4bf9e6d179f6)

В поиске сверху вводим слово **Network** и в пункте **Settings** выбираем искомое.

![5](https://github.com/xarll/vpr/assets/100228870/d78f9b7e-cbd9-46af-8213-662f5bff0542)

В графе **Wired** выбираем шестерёнку настроек.

![6](https://github.com/xarll/vpr/assets/100228870/59ca14c0-e69b-4421-a9d9-b882ab8946c4)

Переходим в раздел **"Ipv4"**

![6-1](https://github.com/xarll/vpr/assets/100228870/69860536-69ab-4a38-89e0-486eb98dd6a2)

В графе **"Ipv4 Method"** выбираем **"Manual"** и в появившемся поле ввода записываем:

- Address: **172.16.0.2**

- Netmask: **255.255.0.0**

- Gateway: **172.16.0.1**

В окне **"DNS"** отключаем кнопку **"Automatic"** и вводим ниже: **8.8.8.8** 

![7](https://github.com/xarll/vpr/assets/100228870/94a6762c-84af-4c67-8064-65e0aa720ca2)

Нажимаем горящую кнопку **"Apply"** в правом верхнем углу окна.


Серверная ВМ имеет IP: **172.16.0.1**

Десктопная ВМ имеет IP: **172.16.0.2**


### 3. Настройка политики IPTABLES

Для начала необходимо посмотреть, какие правила серверной ВМ установлены на данный момент.
```
iptables -L
```
По ум. INPUT (Входящие), OUTPUT (Исходящие) и FORWARD (Проходящие) цепочки - (ACCEPT) разрешены (т.е. предустановленных правил - нет, весь трафик пропускается).

![5](https://github.com/xarll/vpr/assets/100228870/1e0afd24-fa02-4f05-8326-52891dc68703)

Для нашей серверной ВМ по условию лабораторной работы необходимо запретить все входящие и исходящие соединения (кроме **telnet**, **ssh**, **ftp**, **smb** и **ping**)

Начнём с запрета входящих и исходящих соединений.
```
iptables --policy INPUT DROP
iptables --policy OUTPUT DROP
```
Снова проверяем список существующих правил.
```
iptables -L
```
Как мы видим, теперь все входящие и исходящие соединения будут отбрасываться.

![6](https://github.com/xarll/vpr/assets/100228870/429286c5-f10a-49da-a18f-0f7b7030264d)

Если мы попробуем отправить Echo-Request (ping) запросы на десктопную ВМ (клиент) то у нас ничего не выйдет. В обратную сторону тоже.

![7](https://github.com/xarll/vpr/assets/100228870/794a8ac7-56ae-49fa-a19e-0e85137d8cae)

### 4. Настройка правил IPTABLES для протокола TELNET

Попробуем подключиться по **telnet** без настройки.
```
telnet 172.16.0.1
```
Идёт бесконечное подключение - значит файрвол работает корректно.

![10](https://github.com/xarll/vpr/assets/100228870/2e405359-7e45-45a5-8bd3-c858614344e8)

Разрешим десктопной ВМ (клиенту) подключаться к серверной ВМ по данному протоколу. 

На серверной ВМ вводим следующее.
```
iptables -A INPUT -s 172.16.0.2 -p tcp --dport telnet -m state --state NEW,ESTABLISHED -j ACCEPT
```
- **-A** - добавить правило в цепочку;
- **INPUT** - для входящих пакетов;
- **-s "ipa"** - указать IP-адрес оборудования, откуда (source) отправляется пакет данных;
- **-p tcp** - вручную указать протокол (в нашем случае TCP);
- **--dport telnet** - установить порт получателя (destination) telnet;
- **-m state** - отслеживать соединение;
- **--state NEW,ESTABLISHED** - для пакетов, запрашивающих новый сеанс (состояние NEW) и пакетов являющихся частью уже существующего сеанса (состояние ESTABLISHED);
- **-j ACCEPT** - выбрать действие, если правило подошло (-j) и разрешить прохождение пакета дальше по цепочке правил (ACCEPT);

```
iptables -A OUTPUT -d 172.16.0.2 -p tcp --sport 23 -m state --state ESTABLISHED -j ACCEPT
```
- **OUTPUT** - для исходящих пакетов;
- **-d "ipa"** - указать IP-адрес оборудования, куда (destination) отправляется пакет данных;
- **--sport 23** - установить порт устройства-отправителя пакета (source) 23 (порт по ум. для протокола telnet);

Проверим список существующих правил.
```
iptables -L
```
Правила существуют - всё верно.

![11](https://github.com/xarll/vpr/assets/100228870/7b314cb6-c159-467e-b813-08f3eef26f26)

Повторим попытку подключения с помощью **telnet**
```
telnet 172.16.0.1
```
Подключение прошло успешно - правила работают корректно.

![12](https://github.com/xarll/vpr/assets/100228870/7aca4bf5-cf0f-497b-8746-0bd17ab11e70)

### 5. Настройка правил IPTABLES для протокола SSH

Попробуем подключиться по **ssh** без настройки.
```
ssh 172.16.0.1
```
Идёт бесконечное подключение - значит файрвол работает корректно.

![13](https://github.com/xarll/vpr/assets/100228870/1595d82a-54a9-4e90-b0b6-0aa08aeaadd7)

Разрешим десктопной ВМ (клиенту) подключаться к серверной ВМ по данному протоколу. 

На серверной ВМ вводим следующее.
```
iptables -A INPUT -s 172.16.0.2 -p tcp --dport ssh -m state --state NEW,ESTABLISHED -j ACCEPT
```
- **--dport ssh** - установить порт получателя (destination) ssh;
```
iptables -A OUTPUT -d 172.16.0.2 -p tcp --sport 22 -m state --state ESTABLISHED -j ACCEPT
```
- **--sport 22** - установить порт устройства-отправителя пакета (source) 22 (порт по ум. для протокола ssh);
 
Проверим список существующих правил.
```
iptables -L
```
Правила существуют - всё верно.

![14](https://github.com/xarll/vpr/assets/100228870/bef575ef-6c8e-4d7b-ab16-d7bf09c18639)

Повторим попытку подключения с помощью **ssh**
```
ssh 172.16.0.1
```
Подключение прошло успешно - правила работают корректно.

![15](https://github.com/xarll/vpr/assets/100228870/1e6adce9-7ad0-49e4-bada-16701948f46f)

### 6. Настройка правил IPTABLES для протокола SMB

Попробуем подключиться по **smb** без настройки.

Заходим на десктопной ВМ (клиент) в проводник.

![16](https://github.com/xarll/vpr/assets/100228870/1408f215-6391-467c-a62f-cb679dc75e22)

Выбираем последний пункт **Other locations**

![17](https://github.com/xarll/vpr/assets/100228870/f158a6c2-8c19-4f26-924c-cb1373b793c5)

Справа внизу окна есть строка. Вводим в неё следующее:
```
smb://172.16.0.1/
```

![18](https://github.com/xarll/vpr/assets/100228870/de26e528-8b5e-441c-afca-bedce33bfca4)

Нажимаем кнопку **Connect** справа и видим, что идёт бесконечное подключение (файрвол отбрасывает нас)

![19](https://github.com/xarll/vpr/assets/100228870/f746db79-40ca-41da-aa39-202233c747cd)

Разрешим десктопной ВМ (клиенту) подключаться к серверной ВМ по данному протоколу. 

На серверной ВМ вводим следующее.
```
iptables -A INPUT -s 172.16.0.2 -p tcp --dport 445 -m state --state NEW,ESTABLISHED -j ACCEPT
```
- **--dport 445** - установить порт получателя (destination) 445 (по ум. для протокола SMB);
```
iptables -A OUTPUT -d 172.16.0.2 -p tcp --sport 445 -m state --state ESTABLISHED -j ACCEPT
```
- **--sport 445** - установить порт устройства-отправителя пакета (source) 445 (по ум. для протокола SMB);

Проверим список существующих правил.
```
iptables -L
```
Правила существуют - всё верно.

![20](https://github.com/xarll/vpr/assets/100228870/f7484413-e30e-4584-83be-27c6b30ad7e2)

Повторим попытку подключения с помощью **smb**
```
smb://172.16.0.1/
```
Подключение прошло успешно - правила работают корректно.

![21](https://github.com/xarll/vpr/assets/100228870/15377f61-b84a-4d6c-ae8d-a1a1d8924c10)

### 7. Настройка правил IPTABLES для протокола FTP

Попробуем подключиться по **FTP** без настройки.

Переходим в **FileZilla** вводим данные серверной ВМ и нажимаем **Quickconnect**

Наблюдаем сообщение о невозможности подключения - значит файрвол работает корректно.

![22](https://github.com/xarll/vpr/assets/100228870/93cf3095-128f-4cb4-bdea-e3a1c3d30d26)

Разрешим десктопной ВМ (клиенту) подключаться к серверной ВМ по данному протоколу. 

На серверной ВМ вводим следующее.
```
iptables -A INPUT -s 172.16.0.2 -p tcp --dport 21 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A INPUT -s 172.16.0.2 -p tcp --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT
```
- **--dport 21** - установить порт получателя (destination) 21 (по ум. для исходящих соединений протокола FTP);
- **--dport 1024:65535** - установить порт получателя (destination) в диапозоне c 1024-65535 (почему так подробнее тут - https://adminwin.ru/aktivny-i-passivny-rezhim-ftp/ );
```
iptables -A OUTPUT -d 172.16.0.2 -p tcp --dport 20 -m state --state NEW,ESTABLISHED -j ACCEPT
iptables -A OUTPUT -d 172.16.0.2 -p tcp --dport 1024:65535 -m state --state NEW,ESTABLISHED -j ACCEPT
```
- **--dport 20** - установить порт получателя (destination) 20 (по ум. для входящих соединений протокола FTP);

Проверим список существующих правил.
```
iptables -L
```
Правила существуют - всё верно.

![23](https://github.com/xarll/vpr/assets/100228870/d5b822b6-8771-40d1-b0e6-1637f91a619e)

Повторим попытку подключения с помощью **FTP**

![24](https://github.com/xarll/vpr/assets/100228870/0b92efb4-75f5-46fc-85d1-ab55c40b29a5)

Подключение прошло успешно - правила работают корректно.

### 8. Настройка правил IPTABLES для протокола ICMP (ping)

Попробуем сделать пинг по **ICMP** без настройки.
```
ping 172.16.0.1
```
Идёт бесконечное подключение - значит файрвол работает корректно.

![25](https://github.com/xarll/vpr/assets/100228870/f15ef0fd-e8e3-4765-b0c5-987ce768373e)

Разрешим десктопной ВМ (клиенту) подключаться к серверной ВМ по данному протоколу. 

На серверной ВМ вводим следующее.
```
iptables -A INPUT -s 172.16.0.2 -p icmp -j ACCEPT
```
- **-p icmp** - вручную указать протокол (в нашем случае ICMP);
```
iptables -A OUTPUT -d 172.16.0.2 -p icmp -j ACCEPT
```
Проверим список существующих правил.
```
iptables -L
```
Правила существуют - всё верно.

![26](https://github.com/xarll/vpr/assets/100228870/7159b7e4-e066-40b2-a73b-aeb29b10d1e7)

Повторим попытку подключения с помощью **ping**
```
ping 172.16.0.1
```
Пинг прошло успешно - правила работают корректно.

![27](https://github.com/xarll/vpr/assets/100228870/ce340ce0-84f0-42e5-a3f8-610b522f36cb)

### 9. Сохранение правил IPTABLES

После создания всех правил их необходимо сохранить, иначе они исчезнут после перезагрузки операционной системы. Это можно сделать командами:
```
iptables-save > ~/iptables-rules.txt
iptables-restore < ~/iptables-rules.txt
```

## Контрольные вопросы

**1. Что такое iptables?**
