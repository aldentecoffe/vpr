# Лабораторная работа #11 - Использование компьютеров с Linux в качестве шлюзов

## Материалы
- [Лабораторная_работа_№_11_Настройка_шлюза.docx](https://github.com/xarll/vpr/blob/main/items/os1/lab11/%D0%9B%D0%B0%D0%B1%D0%BE%D1%80%D0%B0%D1%82%D0%BE%D1%80%D0%BD%D0%B0%D1%8F_%D1%80%D0%B0%D0%B1%D0%BE%D1%82%D0%B0_%E2%84%96_11_%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D1%88%D0%BB%D1%8E%D0%B7%D0%B0.docx)

## Работа

### 1. Настройка ВМ

Для выполнения работы необходимы:
- Ubuntu Server (https://ubuntu.com/download/desktop)
- Ubuntu Desktop (https://ubuntu.com/download/server)

![1](https://github.com/xarll/vpr/assets/100228870/ba23ee06-9eea-46c4-8c35-413f75178fee)

#### 1-1. Настройка серверной ВМ:

Заходим в пункт **Настройки** --> **Сеть** --> **Адаптер 1**

Тип подключения выбираем **"Сетевой мост"**

![1-1](https://github.com/xarll/vpr/assets/100228870/cc309f42-b6dc-4acf-94ef-e860235fc72c)

Переходим к разделу **Адаптер 2**

Ставим галочку на графе - **"Включить сетевой адаптер"**

Тип подключения - **"Внутренняя сеть"** 

![2](https://github.com/xarll/vpr/assets/100228870/7d3ae864-e2ad-47ad-b289-546750cbd004)

#### 1-2. Настройка десктопной ВМ:

Заходим в пункт **Настройки** --> **Сеть** --> **Адаптер 1**

Ставим галочку на графе - **"Включить сетевой адаптер"**

Тип подключения - **"Внутренняя сеть"**

![3](https://github.com/xarll/vpr/assets/100228870/4fea1e87-35a3-4e81-97d4-f5951c6d30b9)

### 2. Параметры сетевого подключения

#### 2-1. Для десктопной ВМ

Включаем ВМ и выбираем окно **Show Applications**

![4](https://github.com/xarll/vpr/assets/100228870/3319a1b9-da84-4ea5-b2e1-4bf9e6d179f6)

В поиске сверху вводим слово **Network** и в пункте **Settings** выбираем искомое.

![5](https://github.com/xarll/vpr/assets/100228870/d78f9b7e-cbd9-46af-8213-662f5bff0542)

В графе **Wired** выбираем шестерёнку настроек.

![6](https://github.com/xarll/vpr/assets/100228870/59ca14c0-e69b-4421-a9d9-b882ab8946c4)

Переходим в раздел **"Ipv4"**

![6-1](https://github.com/xarll/vpr/assets/100228870/69860536-69ab-4a38-89e0-486eb98dd6a2)

В графе **"Ipv4 Method"** выбираем **"Manual"** и в появившемся поле ввода записываем:

- Address: **172.16.0.2**

- Netmask: **255.255.0.0**

- Gateway: **172.16.0.1**

В окне **"DNS"** отключаем кнопку **"Automatic"** и вводим ниже: **8.8.8.8** 

![7](https://github.com/xarll/vpr/assets/100228870/94a6762c-84af-4c67-8064-65e0aa720ca2)

Нажимаем горящую кнопку **"Apply"** в правом верхнем углу окна.

#### 2-2. Для серверной ВМ

Включаем ВМ и просматриваем сетевые подключения.
```
ip a
```

![8](https://github.com/xarll/vpr/assets/100228870/f65fc774-5a71-46a6-8737-c60a5783e367)

Видим, что добавленный сетевого интерфейс получил название **enp0s8**

В конфигурационный файл **netplan** добавим настройки для данного сетевого интерфейса:
```
nano /etc/netplan/*.yaml
```

![9](https://github.com/xarll/vpr/assets/100228870/16b8d24a-c4b7-4853-a69b-ca26086055a5)

После строки **dhcp4: true** добавляем следующие строки:
```
  enp0s8
    dhcp4: no
    addresses: [172.16.0.1/16]
```
Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

![10](https://github.com/xarll/vpr/assets/100228870/6cdc1a81-b628-4833-a2a8-326901a9a477)

Применяем изменения
```
sudo netplan --debug generate
sudo netplan try
sudo netplan apply
```

Посмотрим внеслись ли изменения
```
ip a
```

![11](https://github.com/xarll/vpr/assets/100228870/55110f0d-ed53-4f0e-a4d0-f012c9f1f5c2)

### 3. Выход во внешнюю сеть через Linux-шлюз

Открываем десктопную ВМ и включаем Терминал.

Командой **ping** проверим наличие связи между виртуальными машинами.
```
ping 172.16.0.1
```

![12](https://github.com/xarll/vpr/assets/100228870/008db6c0-aa7c-4fa5-bfb4-017cecf306bc)

На серверной ВМ разрешим пересылку пакетов, ей не предназначенных. 
```
sudo nano /etc/sysctl.conf
```
Находим строку **#net.ipv4.ip_forward=1** и раскомментируем её.

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

![13](https://github.com/xarll/vpr/assets/100228870/ac131537-f1c5-4730-a9f1-0ebceb131353)

Перезагрузим серверную ВМ:
```
shutdown -r now
```
Выполним команду для включения трансляции сетевых адресов (NAT):
```
sudo iptables -t nat -A POSTROUTING -o enp0s3 -j MASQUERADE
```
На десктопной ВМ откроем браузер и зайдём на какой-либо сайт, например, **youtube.com**, чтобы убедиться в наличии выхода в интернет.

![14](https://github.com/xarll/vpr/assets/100228870/7454d950-0b81-4619-9d84-102aedd8ecd4)

Всё работает - шлюз настроен корректно.

### 4. Доступ из внешней сети во внутреннюю через Linux-шлюз

Установим на десктопную ВМ **Linux HTTP-сервер lighttpd**:
```
sudo apt install lighttpd
```

В серверной ВМ включим перенаправление портов:
```
sudo iptables -t nat -A PREROUTING -i enp0s3 -p tcp --dport 80 -j DNAT --to-destination 172.16.0.2:80
```
(где **172.16.0.2:80** - адрес десктопной ВМ, а 80 - стандартный порт, прослушиваемый HTTP-сервером)

В браузере на каком-либо внешнем компьютере (не на одной их виртуальных машин, используемых в работе) введём адрес внешнего интерфейса серверной ВМ и убедимся, что открывается стартовая страница lighttpd.

На основной системе (не на ВМ) в поисковую строку браузера введём адрес внешнего интерфейса серверной ВМ (192.168.1.98).

Если открывается стартовая страница **lighttpd** - всё сделано правильно.

![15](https://github.com/xarll/vpr/assets/100228870/01f8b730-9fe9-46a3-be37-776751b235dd)

## Контрольные вопросы

**1. Что такое шлюз по умолчанию?**

Шлюз по умолчанию — «default gateway» — это адрес аппаратного или программного маршрутизатора, который позволяет устройствам в одном сегменте сети отправлять информацию устройствам в другие сети.

**2. Что такое NAT? Как он работает?**

Трансляция сетевых адресов (NAT) - это метод, при котором один или несколько локальных IP-адресов переводятся в один или несколько глобальных IP-адресов и наоборот, чтобы предоставить локальным узлам доступ в Интернет.

Запросы NAT являются одной из самых сложных форм сетевых трансляций, обычно затрагивающих большие частные сети с диапазонами от 10.0.0.0 до 10.255.255.255, от 172.16.0.0 до 172.31.255.255 или от 192.168.0 0 до 192.168.255.255, от 100.64.0.0 до 100.127.255.255.

Представьте себе: ваш смартфон, подключенный к домашнему маршрутизатору, должен загрузить потоковое видео одной из ваших любимых передач. Этот запрос передается с телефона на маршрутизатор, а затем в Интернет. Но, прежде чем отправить пакет в Интернет, маршрутизатор меняет исходящий пакет с частного на публичный IP-адрес. Это делается для того, чтобы принимающий сервер мог получить пакет и переслать информацию обратно на ваше устройство. Вот тут-то и приходит на помощь NAT: он следит за тем, чтобы информация возвращалась на ваше устройство как публичный, а не частный адрес.

**3. Что такое внутренняя сеть и внешняя сеть? Как определить, какая сеть внутренняя, а какая внешняя?**

![16](https://github.com/xarll/vpr/assets/100228870/506cd776-9433-43ef-a7e0-beb6a5b7e9a1)

**4. Что такое порт?**

Компьютерный сетевой порт – это число, которое идентифицирует назначение сетевых потоков данных в пределах одного компьютера. Все хосты (компьютеры) обмениваются друг с другом информацией при помощи уникальных цифровых IP-адресов, представленных двоичной системой.

Порты позволяют определить сетевые приложения, работающие на компьютере, множество которых может быть запущено одновременно. Основными сетевыми программами могут быть:

- WEB – сервер, предоставляющий трансляцию данных с веб-сайтов;
- Сервер почты, позволяющие обмениваться электронными письмами;
- FTP – сервер, обеспечивающий передачу информации.

**5. Для чего применяется перенаправление портов? Как оно работает?**

Переадресация портов является частью механизма NAT (трансляции сетевых адресов). Задачей переадресации портов является предоставить доступ из Интернета к сервисам вашей сети, используя открытый порт.

Перенаправление портов — это лучший способ сохранить свой IP-адрес. С его помощью можно защитить клиентские приложения и серверы от взломов и улучшить свою систему. Чаще всего эта процедура используется для защиты публичных IP-адресов. Перенаправление портов позволяет «скрыть» сетевые серверы и сервисы, а также, что еще более важно, создает дополнительный уровень защиты сети.

**6. Перечислите диапазоны частных адресов. Что будет, если использовать во внутренней сети адрес не из диапазона частных?**

![16](https://github.com/xarll/vpr/assets/100228870/bb3e1525-6122-4bb7-9048-76a1c9045621)

Напрямую доступ к сети Интернет, используя частный IP-адрес, невозможен. В этом случае связь с Интернетом осуществляется через NAT (трансляция сетевых адресов заменяет частный IP-адрес на публичный). Частные IP-адреса в пределах одной локальной сети должны быть уникальны и не могут повторяться.
