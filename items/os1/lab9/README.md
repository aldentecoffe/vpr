# Лабораторная работа #9 - Общий доступ к файлам

## Материалы
- [Lab-9 - Общий_доступ_к_файлам.docx](https://github.com/xarll/vpr/blob/main/items/os1/lab9/Lab-9%20-%20%D0%9E%D0%B1%D1%89%D0%B8%D0%B9_%D0%B4%D0%BE%D1%81%D1%82%D1%83%D0%BF_%D0%BA_%D1%84%D0%B0%D0%B9%D0%BB%D0%B0%D0%BC.docx)

## Работа

### 1. Настройка ВМ и NAT сети

Для выполнения работы необходимы:
- Ubuntu Server (https://ubuntu.com/download/desktop)
- Ubuntu Desktop (https://ubuntu.com/download/server)

Настроим сеть для организации общего доступа.

В **Virtual Box** выбираем огромную кнопку **Инструменты** --> **Настройки**

![1](https://github.com/xarll/vpr/assets/100228870/66f6efd4-7ce5-4c64-87cd-23fcd9a9f584)

В открывшемся окне выбираем пункт **Сеть** и нажимаем **Добавить новую сеть NAT** (зелёный привод с плюсом справа):

![2](https://github.com/xarll/vpr/assets/100228870/fff1bae9-294e-497f-8aeb-53a10958cf88)

После чего новая сеть с названием **NatNetwork** появится в списке. Выходим из настроек.

Переходим к десктопной ВМ. Нажимаем по ней ПКМ и выбираем пункт **Настройки**

![3](https://github.com/xarll/vpr/assets/100228870/5bec332a-1f79-467f-8683-87c17a61cee1)

В открывшемся окне выбираем пункт **Сеть** --> **Тип подключения**.

Меняем тип подключения с **NAT** на **Сеть Nat**. Имя сети (по ум.) будет **NatNetwork**

![4](https://github.com/xarll/vpr/assets/100228870/d28aabd4-0a75-4613-8715-19848a54ab01)

Повторяем действия выше для серверной ВМ.

### 2. Установка ПО

**Для серверной ВМ:**
```
sudo apt install vsftpd
sudo apt install samba
```

Проверим запущен ли FTP-сервер:
```
sudo systemctl status smbd
sudo systemctl status vsftpd
```
Если в результатах выполнения предыдущих команд нет зелёной надписи «active(running)», то запускаем службы:
```
sudo systemctl start smbd
sudo systemctl start vsftpd
```


**Для десктопной ВМ:**
```
sudo apt install samba
sudo apt install cifs-utils
sudo apt install filezilla
```
Возможно установить **FileZilla** через магазин приложений. 

Открываем его, в поиск пишем **FileZilla** открываем страницу и устанавливаем нажатием кнопки.

![5](https://github.com/xarll/vpr/assets/100228870/fb1240ff-7786-4699-b2d8-2f4d26a08a0a)


### 3. Адреса ВМ

Для начала узнаём IP наших ВМ.
```
ip a 
```
В моём случае:

Серверная ВМ имеет IP: **10.0.2.5**

Десктопная ВМ имеет IP: **10.0.2.15**

### 4. FTP: Отправка/получение файлов

Для начала создаём файл на серверной ВМ.
```
echo "hello! i am server VM file!" > ~/server-file
```

Переходим в приложение **FileZilla**

Приложение имеет следующий вид:

![6](https://github.com/xarll/vpr/assets/100228870/bbe9229d-40ab-446e-982e-06d1f3f8faa3)

Запускаем FTP-клиент и проверяем наличие подключения к серверу. 

Для этого введём значения в соответствующие поля:

— Хост — IP-адрес виртуальной машины, на которой установлен FTP-сервер.

— Имя пользователя — того, который существует на виртуальной машине с FTP-сервером.

— Порт можно оставить пустым, так как будет использован стандартный порт 21.

Теперь вписываем данные в окна и нажимаем **Quickconnect**

Если в консоли приложения появилась надпись
```
Status: Directory listing of "/home/user-name" succesfull
```
И в окне **Remote site** виден наш только что созданный файл - всё выполненно корректно.

![7](https://github.com/xarll/vpr/assets/100228870/e1b48065-e017-44a0-a8b1-2128464ca708)

Скопируем созданный файл с серверной ВМ на десктопную ВМ.

Зажатием ЛКМ на файл перетягиваем его в окно **Local site**. Заходим 

Переходим в терминал десктопной ВМ. Просматриваем домашнюю директорию.
```
ls /home/user-name
```
Если файл присутствует в директории - всё верно.

![8](https://github.com/xarll/vpr/assets/100228870/0bbc7d0c-b29e-47d8-82c4-8c3839134cf1)

Далее необходимо провести обратную операцию. Создаём файл на десктопной ВМ.
```
echo "hello! i am desktop VM file!" > /home/desktop-user-name/desktop-file
```
![9](https://github.com/xarll/vpr/assets/100228870/04d9466d-b444-424f-ab6a-91af1d136347)

!! Но отправить файл с десктопной на серверную ВМ с ходу не получится. Для этого необходимо отредактировать конфигурационный файл FTP-сервера. Если попробовать передать файл без редактирования - операция завершится с ошибкой !!

Разрешаем загрузку файлов на сервер. Для этого откроем конфигурационный файл FTP-сервера (Серверная ВМ):
```
sudo nano /etc/vsftpd.conf
```
Находим в нём строку «#write_enable=yes» и раскомментируем её, убрав #.

![10](https://github.com/xarll/vpr/assets/100228870/9b0515fa-7958-45d2-900c-d1cef682e31b)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Перезапустим FTP-сервер:
```
sudo systemctl restart vsftpd
```

Теперь возвращаемся на десктопную ВМ в **FileZilla**.

В окне **Local site** ищем файл **desktop-file** и зажатием по нему ЛКМ переносим его в **Remote site**

![11](https://github.com/xarll/vpr/assets/100228870/b9c6a051-fda3-448a-a165-7209f2ad07c0)

На всякий случай проверяем наличие файла на серверной ВМ.
```
ls /home/server-user-name/
```
Файл присутствует - всё правильно.

![12](https://github.com/xarll/vpr/assets/100228870/e5f87463-f969-4b03-9adb-2445d61c070f)

### 5. FTP: Анонимный вход

Открываем файл конфигурации
```
/etc/vsftpd.conf
```
Находим строку «anonymous_enable=NO» и замените на «anonymous_enable=YES»

![13](https://github.com/xarll/vpr/assets/100228870/26ed6ad1-7db2-40b4-a08b-2ae1fdc5ace0)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Перезапускаем FTP-сервер.
```
sudo systemctl restart vsftpd
```

Заново подключаемся к серверу на этот раз не указывая **ни имя пользователя, ни пароль**.
После успешного подключения обратим внимание, что список папок и фалов сервера пуст. Это происходит из-за того, что для анонимных пользователей выделена специальная папка, за пределы которой они не могут обращаться. 

По умолчанию **vsftp** использует для этого папку **/srv/ftp**.

![14](https://github.com/xarll/vpr/assets/100228870/df91745c-55c4-4a58-8edf-436700544cf1)

На серверной ВМ создадим любой файл 
```
echo "hello! i am anonymous file!" | sudo tee /srv/ftp/anon-file
```

![15](https://github.com/xarll/vpr/assets/100228870/62600645-f0e1-4358-800d-93673623d9dc)

Ознакомимся с командой **tee**: 

*tee — команда, выводит на экран, или же перенаправляет выходной поток команды и копирует его содержимое в файл или в переменную. В первую очередь, команда используется в привязке с перенаправлениями и фильтрами.*

Убедимся, что этот файл отобразился в списке файлов сервера на FTP-клиенте и скачиваем его. 

![16](https://github.com/xarll/vpr/assets/100228870/04ab657b-ceea-48cb-a2f1-5fffdaa585d8)

При попытке загрузить что-либо на сервер с десктопной ВМ мы получим ошибку. Для того, что бы загрузка стала возможно возвращаемся в конфиг.

Открываем файл конфигурации FTP-сервера
```
/etc/vsftpd.conf
```
Найдите в нём и раскомментируем строчку «anon_upload_enable=yes», а также самостоятельно добавляем строчку «anon_other_write_enable=YES»

![17](https://github.com/xarll/vpr/assets/100228870/9f5a215f-bef7-4076-bc4e-fbe7166c322b)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Перезапускаем FTP-сервер.
```
sudo systemctl restart vsftpd
```
Создадим папку внутри **/srv/ftp** и сменим её владельца командой **chown**:
```
sudo mkdir /srv/ftp/upload
sudo chown root:ftp /srv/ftp/upload
sudo chmod g+w /srv/ftp/upload
```
Посмотрим права доступа директории.
```
ls -l /srv/ftp/
```

![18](https://github.com/xarll/vpr/assets/100228870/01da8bca-c6e1-4330-a87b-4d281407e25d)

Переходим на декстопную ВМ. Восстанавливаем анонимное подключение. В окне **Remote site** находим новую папку **upload** и открываем её дабл-кликом.

Теперь из окна **Local site** зажатием ЛКМ перетянем файл **server-file** в директорию **upload**.

Попытка должна быть успешной.

![19](https://github.com/xarll/vpr/assets/100228870/c8b384fc-3b1f-47d9-a8c1-db9a6b9e20ab)

Попробуем скачать обратно на десктоп только что загруженный файл и убедимся, что это невозможно.

![20](https://github.com/xarll/vpr/assets/100228870/8b56831f-86ed-4936-bc73-9e584ffeeb58)

На серверной ВМ добавим файлу право на чтение остальными пользователями:
```
chmod o+r /srv/ftp/upload/server-file
```
Ещё раз попробуем скачать данный файл с FTP-сервера. На этот раз попытка должна быть успешной.

Из окна **Remote site** зажатием ЛКМ перетянем файл **server-file** в окно **Local site**.

Подтверждаем перезапись. Файл передан - всё сделано правильно.

![21](https://github.com/xarll/vpr/assets/100228870/540dabfa-ae58-4f64-ab8c-69f5be87f3a6)

![22](https://github.com/xarll/vpr/assets/100228870/dc6b85d3-2834-4689-b3d1-64ed645809b6)

Открываем файл конфигурации FTP-сервера
```
/etc/vsftpd.conf
```
Добавим следующую строку «anon_umask=022». Это необходимо, чтобы FTP-сервер автоматически присваивал закачиваемым файлам правильные права.

*umask — (маска режима создания пользовательских файлов) — функция среды POSIX, изменяющая права доступа, которые присваиваются новым файлам и каталогам по умолчанию. Права доступа файлов, созданных при конкретном значении umask, вычисляются при помощи следующих побитовых операций (umask обычно устанавливается в восьмеричной системе счисления)*

![23](https://github.com/xarll/vpr/assets/100228870/9bd68507-532a-4420-8792-2fc98449d034)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Перезапускаем FTP-сервер.
```
sudo systemctl restart vsftpd
```
Заново загружаем файл на FTP-сервер и скачиваем его оттуда.

Из окна **Local site** зажатием ЛКМ перетянем файл **server-file** в окно **Remote site** (в папку upload)

Подтверждаем два раза перезапись. Если файл успешно прошёл путь с одной ВМ на другую - всё правильно.

![24](https://github.com/xarll/vpr/assets/100228870/e15b09c9-7eae-4908-86c8-d44de663be60)

### 6. FTP: Использование команд для доступа к серверу

Создадим файл для отправки его через консоль десктопной версии.
```
echo "hello! put me with a console pls" > /home/const/put-me-file
```
![24-1](https://github.com/xarll/vpr/assets/100228870/9691ad55-7891-4aa7-bc0a-1fa3a4790d61)

На десктопной версии ВМ откроем терминал и введите команду
```
ftp 10.0.2.5
```
Подставив вместо «10.0.2.5» реальный адрес виртуальной машины с FTP-сервером.

При запросе введём сначала логин, потом пароль пользователя, существующего на сервере.

![25](https://github.com/xarll/vpr/assets/100228870/2ac9023c-b081-4914-9fb0-fd59515ea1ce)

Загрузим серверную ВМ новый файл, введя команду FTP (не интерпретатора команд Linux):
```
put /home/const/put-me-file
```

![26](https://github.com/xarll/vpr/assets/100228870/355a79bc-3802-4f81-b796-f7c1111a56d1)

Проанализируем полученные FTP-ответы на серверной ВМ.
```
ls /home/const/
```

![27](https://github.com/xarll/vpr/assets/100228870/7d3d0c5f-9866-48d0-836b-4a833ada7601)

Скачаем его обратно, но сохранив под другим именем, введя FTP-команду:
```
get put-me-file put-me-file-back
```

![28](https://github.com/xarll/vpr/assets/100228870/95bde5ff-b530-4c72-b273-87486c642e1a)

Отключаемся от FTP-сервера:
```
exit
```

![29](https://github.com/xarll/vpr/assets/100228870/599b155f-1390-42e0-87b4-3b2586699c2e)

Проанализируем полученные FTP-ответы на десктопной ВМ.
```
cat /home/const/put-me-file-back
```
Файл существует и читается - всё отлично.

![30](https://github.com/xarll/vpr/assets/100228870/c56f25bc-71f2-48bc-956f-c725404ce238)

### 7. SMB: Создание общего ресурса

Проверяем возможность подключения к серверу по SMB. Для этого на виртуальной машине с десктопной версией Linux открываем менеджер файлов, выбираем **Другие места**. 

Внизу видим надпись **Connect to Server**. Записываем в окно рядом следующее:
```
smb://10.0.2.5
```
И нажимаем подключение.

![30-1](https://github.com/xarll/vpr/assets/100228870/20835be0-8108-4532-9134-742e22e8e1dd)

Переходим на серверную ВМ и создаём папку с общим доступом.
```
mkdir /home/const/shared
```

Далее необходимо настроить конфиг SMB
```
sudo nano /etc/samba/smb.conf
```
Добавляем в конец файла следующее:
```
[Shared]
   path = /home/const/shared
   browseable = yes
   writeable = yes
   guest ok = yes
   read only = no
```

![31](https://github.com/xarll/vpr/assets/100228870/86830b29-0782-49e3-8ce7-acdc34f8b8c2)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Перезапускаем SMB.
```
sudo systemctl restart smbd
```
На десктопной ВМ проверяем наличие доступа к созданной общей папке.

Проводим повторное подключение и видим следующее:

![32](https://github.com/xarll/vpr/assets/100228870/528c00f0-1f60-47a2-8be8-bb0b2eb9ac02)

Для того, что бы создать файл в общей сетевой папке с десктопной ВМ необходимо настроить конфиг SMB.
```
sudo nano /etc/samba/smb.conf
```

### 8. SMB: Добавления пользователя

Допишем в конец файла строчку:
```
valid users = имя_пользователя»
```
(заменив имя_пользователя на имя реально существующего на Linux Server пользователя)

![33](https://github.com/xarll/vpr/assets/100228870/dbb2bb5e-d14a-40af-b721-db5502053a45)

Сохраняем файл (Ctrl+O) и закрываем редактор (Ctrl+X).

Далее необходимо занести этого пользователя в БД samba:
```
sudo smbpasswd -a const
```
Необходимо ввести пароль, который будет использоваться для доступа по SMB (не пароль пользователя Linux)

Далее перезапускаем SMB.
```
sudo systemctl restart smbd
```
Возвращаемся к десктопной ВМ.

Заходим в общую папку **Shared**

При запросе авторизационных данных вводим имя пользователя и пароль, заданные в предыдущей команде.

![34](https://github.com/xarll/vpr/assets/100228870/0e9a9e05-07e9-45b0-906f-c0860141a34c)

### 9. SMB: Монтирование общей папки

Продолжаем работать на десктопной ВМ.

Создадим папку в домашнем каталоге пользователя.
```
mkdir /home/const/from-server-dir
```
Далее проведём монтирование:
```
sudo mount -t cifs -o user=const,password=key,file_mode=0777,dir_mode=0777 //10.0.2.5/shared /home/const/from-server-dir
```
Пробелы между user, password, file_mode и dir_mode не ставятся.

Проверим корректность монтирования. 

На серверной ВМ создадим в общей папке файл и проверим его наличие в смонтированном разделе на десктопной ВМ.
```
echo "hello! i am samba file!" > /home/const/shared/samba-file
```

![35](https://github.com/xarll/vpr/assets/100228870/4b153e25-9b13-4e81-8425-a94270fa1853)

Переходим на десктопную ВМ и проверяем существует ли данный файл.
```
ls /home/const/from-server-dir
```

![36](https://github.com/xarll/vpr/assets/100228870/0bfa1d68-81c5-4cc3-b154-f9e3ce6cedf5)

Файл существует - всё сделанно верно.

Можем переходить к размонтированию папки на десктопной ВМ.
```
sudo umount /home/const/from-server-dir
```

![37](https://github.com/xarll/vpr/assets/100228870/bea27bfd-b64f-4d07-8461-efbfaf1b1e59)

## Контрольные вопросы

**1. Каковы основные особенности протокола FTP?**

File Transfer Protocol, или протокол передачи файлов, — это протокол, относящийся к прикладному уровню и отвечающий за передачу данных между двумя системами. Как и протокол HTTP, он работает поверх протокола TCP. При передаче файлов FTP использует одновременно два TCP-канала: один из них отвечает за управление передачей данных, а второй — передает их.

**2. Какие порты использует по умолчанию FTP?**

По умолчанию используется 21-й порт.

**3. Что такое пассивный режим работы FTP?**

Пассивный режим работы FTP протокола подразумевает работу сервера в «пассивном» режиме, когда он и для передачи данных ожидает соединения по инициативе клиента. Это позволяет практически любому компьютеру, который имеет доступ в интернет через NAT (популярный тип гейта) пользоваться FTP протоколом.

**4. Что такое анонимный доступ к FTP?**

Анонимный доступ к серверу FTP позволяет пользователям работать с некоторыми ресурсами удаленной системы, не указывая пароль. Набор общих данных определяется на удаленном сервере. Такие данные доступны любому пользователю. Ответственность за выбор общих ресурсов ложится на владельца ресурсов и администратора системы.

**5. Как создать новый общий ресурс, доступный по протоколу SMB?**

Необходимо создать папку и с помощью конфигурационного файла **smb** настроить её.

**5. Как смонтировать сетевую папку, доступную по протоколу SMB?**

Необходима утилита **cifs** и созданный **smb** пользователь.

Монтирование выполняется командой **mount** с указанием флагов, имени **smb** пользователя и его пароля, параметрами разрешений и направлениями (откуда куда).

sudo mount -t cifs -o user=имя_пользователя,password=пароль,file_mode=0777, dir_mode=0777 //адрес_общей_папки /точка_монтирования
